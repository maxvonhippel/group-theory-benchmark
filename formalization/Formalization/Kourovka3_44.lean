/-
Kourovka Notebook Problem 3.44 (B. I. Plotkin)

Suppose that a group is generated by its subinvariant soluble subgroups.
Is it necessarily locally soluble?

DEFINITIONS:
- A subgroup H of G is **subinvariant** (also called **subnormal**) if there exists
  a finite chain H = H₀ ⊴ H₁ ⊴ ... ⊴ Hₙ = G where each Hᵢ is normal in Hᵢ₊₁.
- A group G is **locally solvable** if every finitely generated subgroup of G is solvable.
- A group is **generated by its subinvariant solvable subgroups** if it equals the
  subgroup generated by the union of all its subnormal solvable subgroups.
-/

import Mathlib.GroupTheory.Solvable
import Mathlib.Data.Set.Finite.Basic
import Mathlib.Data.Finset.Basic

open Subgroup

variable {G : Type*} [Group G]

/--
A subnormal series from H to K is a finite sequence of subgroups
H = H₀ ⊴ H₁ ⊴ ... ⊴ Hₙ = K where each is normal in the next.
We represent this as a list of subgroups with the normality property.
-/
structure SubnormalSeries (H K : Subgroup G) where
  /-- The chain of subgroups, starting with H and ending with K -/
  chain : List (Subgroup G)
  /-- The chain is nonempty -/
  chain_nonempty : chain ≠ []
  /-- The first subgroup is H -/
  head_eq : chain.head chain_nonempty = H
  /-- The last subgroup is K -/
  last_eq : chain.getLast chain_nonempty = K
  /-- Each subgroup in the chain is normal in the next -/
  normal_chain : ∀ i : Fin (chain.length - 1),
    let Hi := chain.get ⟨i.val, Nat.lt_of_lt_pred i.isLt⟩
    let Hi1 := chain.get ⟨i.val + 1, Nat.lt_pred_iff.mp i.isLt⟩
    ∀ (_ : Hi ≤ Hi1), (Hi.subgroupOf Hi1).Normal

/--
A subgroup H is **subnormal** (or **subinvariant**) in G if there exists a
subnormal series from H to ⊤ (the whole group).
-/
def Subgroup.IsSubnormal (H : Subgroup G) : Prop :=
  Nonempty (SubnormalSeries H ⊤)

/--
A subgroup H is a **subnormal solvable subgroup** if it is both subnormal and solvable.
-/
def Subgroup.IsSubnormalSolvable (H : Subgroup G) : Prop :=
  H.IsSubnormal ∧ IsSolvable H

/--
The set of all subnormal solvable subgroups of G.
-/
def subnormalSolvableSubgroups (G : Type*) [Group G] : Set (Subgroup G) :=
  { H : Subgroup G | H.IsSubnormalSolvable }

/--
The subgroup generated by all subnormal solvable subgroups.
This is the join (supremum) of all such subgroups in the lattice of subgroups.
-/
noncomputable def generatedBySubnormalSolvable (G : Type*) [Group G] : Subgroup G :=
  ⨆ H ∈ subnormalSolvableSubgroups G, H

/--
A group G is **generated by its subnormal solvable subgroups** if the subgroup
generated by all such subgroups equals the whole group.
-/
def isGeneratedBySubnormalSolvable (G : Type*) [Group G] : Prop :=
  generatedBySubnormalSolvable G = ⊤

/--
A group G is **locally solvable** if every finitely generated subgroup is solvable.

Note: A subgroup is finitely generated if its carrier can be expressed as the
closure of a finite set.
-/
def IsLocallySolvable (G : Type*) [Group G] : Prop :=
  ∀ (S : Finset G), IsSolvable (closure (S : Set G))

/--
**Plotkin's Question (Problem 3.44):**

If a group G is generated by its subnormal solvable subgroups,
is G necessarily locally solvable?

This is stated as a conjecture (implication). The answer could be:
- True: The implication holds for all groups
- False: There exists a counterexample
-/
theorem plotkin_question
    (G : Type*) [Group G]
    (hGen : isGeneratedBySubnormalSolvable G) :
    IsLocallySolvable G := by
  sorry
