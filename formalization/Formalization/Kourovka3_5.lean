/-
Kourovka Notebook Problem 3.5 (N. R. Brumberg)

Can a subgroup of a relatively free group be radicable?
In particular, can a verbal subgroup of a relatively free group be radicable?

Key definitions:
- A group is *radicable* (or divisible) if for every element g and positive integer n,
  there exists h such that h^n = g.
- A *relatively free group* is a group that is free in some variety of groups.
  A variety is a class of groups defined by a set of identities (laws).
- A *verbal subgroup* is the subgroup generated by all values of a word w in the group.
-/

import Mathlib.Algebra.Group.Defs
import Mathlib.Algebra.Group.Subgroup.Defs
import Mathlib.Algebra.Group.Subgroup.Lattice
import Mathlib.GroupTheory.FreeGroup.Basic
import Mathlib.GroupTheory.QuotientGroup.Basic

universe u v

/-!
## Radicable Groups
-/

/--
A group G is *radicable* (also called *divisible*) if every element has an n-th root
for every positive integer n. That is, for every g ∈ G and n ≥ 1, there exists h ∈ G
such that h^n = g.
-/
def IsRadicable (G : Type*) [Group G] : Prop :=
  ∀ (g : G) (n : ℕ), n ≠ 0 → ∃ h : G, h ^ n = g

/--
A subgroup H of G is radicable if it is radicable as a group and closed under taking
n-th roots (when they exist in H). More precisely, for every h ∈ H and n ≥ 1, there
exists x ∈ H such that x^n = h.
-/
def Subgroup.IsRadicable {G : Type*} [Group G] (H : Subgroup G) : Prop :=
  ∀ (g : H) (n : ℕ), n ≠ 0 → ∃ h : H, h ^ n = g

/-!
## Group Words and Verbal Subgroups
-/

/-- A group word on n variables is an element of the free group on n generators. -/
abbrev GroupWord (n : ℕ) := FreeGroup (Fin n)

/--
Evaluate a word by substituting group elements for variables.
This uses the universal property of free groups.
-/
noncomputable def evalWord {n : ℕ} {G : Type*} [Group G] (w : GroupWord n) (σ : Fin n → G) : G :=
  FreeGroup.lift σ w

/--
The set of all values of a word w in a group G, i.e., all elements of the form
w(g₁, ..., gₙ) for g₁, ..., gₙ ∈ G.
-/
def wordValues {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) : Set G :=
  { g : G | ∃ σ : Fin n → G, g = evalWord w σ }

/--
The verbal subgroup of G generated by a word w is the subgroup generated by all values
of w in G. This is the smallest subgroup containing all w(g₁, ..., gₙ).
-/
def verbalSubgroup {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) : Subgroup G :=
  Subgroup.closure (wordValues G w)

/--
The verbal subgroup is a normal subgroup (this is a standard fact in group theory).
-/
theorem verbalSubgroup_normal {n : ℕ} {G : Type*} [Group G] (w : GroupWord n) :
    (verbalSubgroup G w).Normal := by
  sorry

/-!
## Varieties and Relatively Free Groups

A variety of groups is a class of groups closed under subgroups, quotients, and direct products.
By Birkhoff's theorem, varieties correspond bijectively to sets of identities (laws).
A relatively free group in a variety V is the free object in V.
-/

/--
A variety of groups is specified by a set of laws (identities).
Each law is a word that must evaluate to 1 for all substitutions.
We represent this as a family of words indexed by some type.
-/
structure GroupVariety.{w} where
  /-- Index type for the laws -/
  ι : Type w
  /-- The number of variables for each law -/
  arity : ι → ℕ
  /-- The laws defining the variety -/
  laws : (i : ι) → GroupWord (arity i)

/--
A group G satisfies a variety V if all laws of V hold in G.
-/
def SatisfiesVariety (G : Type*) [Group G] (V : GroupVariety) : Prop :=
  ∀ (i : V.ι) (σ : Fin (V.arity i) → G), evalWord (V.laws i) σ = 1

/--
The verbal subgroup of a free group determined by a variety V.
This is generated by all values of all laws in V.
-/
noncomputable def varietyVerbalSubgroup (V : GroupVariety.{u}) (X : Type v) :
    Subgroup (FreeGroup X) :=
  ⨆ (i : V.ι), Subgroup.closure { g : FreeGroup X |
    ∃ σ : Fin (V.arity i) → FreeGroup X, g = evalWord (V.laws i) σ }

/--
The verbal subgroup determined by a variety is normal.
This is because conjugates of word values are also word values (under different substitutions).
-/
instance varietyVerbalSubgroup_normal (V : GroupVariety.{u}) (X : Type v) :
    (varietyVerbalSubgroup V X).Normal := by
  sorry

/--
A relatively free group in variety V on generators X is the quotient of the free group
on X by the verbal subgroup determined by V.

This is the "free object" in the variety V.
-/
noncomputable def RelativelyFreeGroup (V : GroupVariety.{u}) (X : Type v) : Type (max u v) :=
  (FreeGroup X) ⧸ (varietyVerbalSubgroup V X)

/--
A group G is a relatively free group if it is isomorphic to the relatively free group
in some variety V on some set of generators.
-/
def IsRelativelyFree (G : Type*) [Group G] : Prop :=
  ∃ (V : GroupVariety) (X : Type), Nonempty (G ≃* RelativelyFreeGroup V X)

/-!
## Main Problem Statement
-/

/--
**Kourovka Problem 3.5 (First Part)**: Can a subgroup of a relatively free group be radicable?

The question asks whether there exists a relatively free group G with a subgroup H
that is radicable.
-/
def kourovka_3_5_part1 : Prop :=
  ∃ (G : Type) (_ : Group G),
    IsRelativelyFree G ∧
    ∃ H : Subgroup G, H.IsRadicable

/--
**Kourovka Problem 3.5 (Second Part)**: Can a verbal subgroup of a relatively free group
be radicable?

This is the more specific question: can the verbal subgroup (generated by a word)
of a relatively free group be radicable?
-/
def kourovka_3_5_part2 : Prop :=
  ∃ (G : Type) (_ : Group G),
    IsRelativelyFree G ∧
    ∃ (n : ℕ) (w : GroupWord n), (verbalSubgroup G w).IsRadicable

/--
The full problem asks both questions. The second is a special case of the first
(since every verbal subgroup is a subgroup), but a positive answer to the first
does not necessarily answer the second.
-/
theorem kourovka_3_5 :
    (kourovka_3_5_part1 ↔ True) ∨  -- Either there exists such a subgroup
    (kourovka_3_5_part1 ↔ False)   -- Or no such subgroup exists
    := by
  sorry

/--
For the verbal subgroup version:
-/
theorem kourovka_3_5_verbal :
    (kourovka_3_5_part2 ↔ True) ∨  -- Either there exists such a verbal subgroup
    (kourovka_3_5_part2 ↔ False)   -- Or no such verbal subgroup exists
    := by
  sorry
