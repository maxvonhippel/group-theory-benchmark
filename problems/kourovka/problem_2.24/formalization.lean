/-
Kourovka Notebook Problem 2.45.b (P. Hall)

Prove or refute the following conjecture: If the marginal subgroup v*G has finite
index m in G, then the order of vG is finite and divides a power of m.

Editors' comment: There are examples when |vG| does not divide a power of m
(Yu. G. Kleiman, Trans. Moscow Math. Soc., 1983, no. 2, 63–110), but the question
of finiteness remains open.

DEFINITIONS:
- A "word" or "variety" v is an element of a free group F_n (a group word in n variables).
- The **verbal subgroup** vG is the subgroup of G generated by all values of v
  under all substitutions σ : Fin n → G.
- The **marginal subgroup** v*G consists of all elements g ∈ G such that for any
  substitution σ and any variable x_i, replacing x_i by x_i * g in the word
  gives the same result as the original substitution (i.e., g "commutes past" the word).

The conjecture has two parts:
1. [Open] If [G : v*G] = m < ∞, then vG is finite.
2. [Refuted] If [G : v*G] = m < ∞ and vG is finite, then |vG| divides m^k for some k.

The second part was shown to be false by Kleiman (1983), but the first part
(finiteness of vG given finite index of v*G) remains an open question.
-/

import Mathlib.GroupTheory.FreeGroup.Basic
import Mathlib.GroupTheory.Index

open Subgroup

/--
A group word is an element of the free group on n generators.
When we evaluate this word by substituting group elements for the generators,
we get an element of G.
-/
abbrev GroupWord (n : ℕ) := FreeGroup (Fin n)

/--
Given a group G and a function assigning elements of G to each generator,
we can evaluate a word in the free group to get an element of G.
This uses the universal property of free groups.
-/
noncomputable def evalWord {n : ℕ} {G : Type*} [Group G] (w : GroupWord n) (σ : Fin n → G) : G :=
  FreeGroup.lift σ w

/--
The **verbal subgroup** vG associated to a word w is the subgroup generated by
all values of w under all possible substitutions from G.
-/
def verbalSubgroup {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) : Subgroup G :=
  closure { g : G | ∃ σ : Fin n → G, evalWord w σ = g }

/--
Given a substitution σ : Fin n → G and an element g ∈ G, we can form a new substitution
that replaces the i-th variable with (σ i) * g.
-/
def substWithMarginal {n : ℕ} {G : Type*} [Group G] (σ : Fin n → G) (i : Fin n) (g : G) : Fin n → G :=
  Function.update σ i (σ i * g)

/--
An element g ∈ G is **marginal** with respect to a word w if multiplying g into any
variable position of any substitution does not change the value of the word.

More precisely: g is marginal if for all substitutions σ and all variables x_i,
we have w(x_1, ..., x_i * g, ..., x_n) = w(x_1, ..., x_i, ..., x_n).
-/
def isMarginal {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) (g : G) : Prop :=
  ∀ (σ : Fin n → G) (i : Fin n), evalWord w (substWithMarginal σ i g) = evalWord w σ

/--
The **marginal subgroup** v*G is the set of all marginal elements.
This is indeed a subgroup (proof obligations use sorry).
-/
def marginalSubgroup {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) : Subgroup G where
  carrier := { g : G | isMarginal G w g }
  one_mem' := by
    simp only [Set.mem_setOf_eq, isMarginal, substWithMarginal]
    intro σ i
    congr 1
    ext j
    simp only [Function.update, mul_one]
    split_ifs with h
    · subst h; rfl
    · rfl
  mul_mem' := by
    intro a b ha hb
    simp only [Set.mem_setOf_eq, isMarginal, substWithMarginal] at *
    intro σ i
    -- The proof that marginality is closed under multiplication
    sorry
  inv_mem' := by
    intro a ha
    simp only [Set.mem_setOf_eq, isMarginal, substWithMarginal] at *
    intro σ i
    -- The proof that marginality is closed under inverses
    sorry

/--
**Hall's Conjecture (Finiteness Part - OPEN):**

If the marginal subgroup v*G has finite index m in G, then the verbal subgroup vG is finite.

This remains an open problem as of the Kourovka Notebook commentary.
-/
theorem hall_conjecture_finiteness
    (G : Type*) [Group G]
    (n : ℕ) (w : GroupWord n)
    (hFiniteIndex : (marginalSubgroup G w).index ≠ 0) :
    (verbalSubgroup G w).carrier.Finite := by
  sorry

/--
**Hall's Conjecture (Divisibility Part - REFUTED):**

The original conjecture also claimed that if [G : v*G] = m, then |vG| divides m^k
for some k. This was shown to be FALSE by Yu. G. Kleiman (1983).

We state this as: there exist groups where the index is finite but the order of
the verbal subgroup does not divide any power of the index.
-/
theorem hall_conjecture_divisibility_counterexample :
    ∃ (G : Type*) (_ : Group G) (_ : Fintype G)
      (n : ℕ) (w : GroupWord n),
      let m := (marginalSubgroup G w).index
      let v := Nat.card (verbalSubgroup G w)
      m ≠ 0 ∧ ∀ k : ℕ, ¬ (v ∣ m ^ k) := by
  sorry
