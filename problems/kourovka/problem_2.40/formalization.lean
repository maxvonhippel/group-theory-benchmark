/-
Kourovka Notebook Problem 2.45b (P. Hall)

Prove or refute the following conjecture: If the marginal subgroup v*G has finite
index m in G, then the order of vG is finite and divides a power of m.

Editors' comment: There are examples when |vG| does not divide a power of m
(Yu. G. Kleiman, Trans. Moscow Math. Soc., 1983, no. 2, 63–110), but the question
of finiteness remains open.

Key concepts:
- A variety of groups is defined by a set of words/laws
- The verbal subgroup vG is generated by all values of words in the variety
- The marginal subgroup v*G consists of elements g such that substituting g
  for any variable in any word doesn't change the value (compared to substituting 1)

The conjecture has two parts:
1. |vG| is finite when [G : v*G] = m is finite
2. |vG| divides m^k for some k

Part 2 is FALSE (Kleiman's counterexample). Part 1 remains OPEN.
-/

import Mathlib.GroupTheory.FreeGroup.Basic
import Mathlib.GroupTheory.Index
import Mathlib.Data.Set.Finite.Basic

open scoped Pointwise

/-- A group word on n variables is an element of the free group on n generators. -/
abbrev GroupWord (n : ℕ) := FreeGroup (Fin n)

/-- Evaluate a word by substituting group elements for generators. -/
noncomputable def evalWord {n : ℕ} {G : Type*} [Group G] (w : GroupWord n) (σ : Fin n → G) : G :=
  FreeGroup.lift σ w

/--
The verbal subgroup generated by a single word w is the subgroup generated by
all values of w under all possible substitutions.
-/
def verbalSubgroup {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) : Subgroup G :=
  Subgroup.closure { g : G | ∃ σ : Fin n → G, evalWord w σ = g }

/--
An element g is in the marginal subgroup for word w if substituting g for any
variable (while keeping others fixed) gives the same result as substituting 1.

For a word w(x₁, ..., xₙ), g is marginal if for all i and all choices of
a₁, ..., aₙ, we have:
  w(a₁, ..., a_{i-1}, g, a_{i+1}, ..., aₙ) = w(a₁, ..., a_{i-1}, 1, a_{i+1}, ..., aₙ)
-/
def isMarginalFor {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) (g : G) : Prop :=
  ∀ (σ : Fin n → G) (i : Fin n),
    evalWord w (Function.update σ i g) = evalWord w (Function.update σ i 1)

/--
The marginal subgroup for a word w consists of all elements that are marginal for w.
-/
def marginalSubgroup {n : ℕ} (G : Type*) [Group G] (w : GroupWord n) : Subgroup G where
  carrier := { g : G | isMarginalFor G w g }
  one_mem' := by
    intro σ i
    rfl
  mul_mem' := by
    intro a b ha hb σ i
    -- This requires showing the marginal property is closed under multiplication
    -- This is non-trivial and involves the structure of free groups
    sorry
  inv_mem' := by
    intro a ha σ i
    -- This requires showing the marginal property is closed under inverses
    sorry

/--
Kourovka Problem 2.45b (P. Hall) - First part (finiteness, still OPEN):

If the marginal subgroup v*G has finite index m in G, then the verbal subgroup vG
has finite cardinality.

This is formalized for a single word w (the general case involves a set of words
defining a variety, but the single-word case captures the essence).
-/
theorem kourovka_2_45b_finiteness
    {n : ℕ} (G : Type*) [Group G]
    (w : GroupWord n)
    (h_finite_index : (marginalSubgroup G w).FiniteIndex) :
    (verbalSubgroup G w).carrier.Finite := by
  sorry

/--
Kourovka Problem 2.45b (P. Hall) - Second part (divisibility, REFUTED):

The original conjecture also claimed that |vG| divides m^k for some k,
where m = [G : v*G]. This was shown to be FALSE by Kleiman (1983).

We state the negation: there exists a finite group G and word w where the verbal
subgroup is finite but its order does not divide any power of the index.
-/
theorem kourovka_2_45b_divisibility_counterexample :
    ∃ (n : ℕ) (G : Type*) (_ : Group G) (_ : Fintype G) (w : GroupWord n),
      let vG := verbalSubgroup G w
      let vStarG := marginalSubgroup G w
      vStarG.FiniteIndex ∧
      ¬∃ (k : ℕ), Nat.card vG ∣ vStarG.index ^ k := by
  sorry
