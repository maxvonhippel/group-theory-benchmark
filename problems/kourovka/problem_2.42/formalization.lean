/-
Kourovka Notebook Problem 2.45 b) (P. Hall)

Prove or refute the following conjecture: If the marginal subgroup v*G has finite
index m in G, then the order of vG is finite and divides a power of m.

Editors' comment: There are examples when |vG| does not divide a power of m
(Yu. G. Kleiman, Trans. Moscow Math. Soc., 1983, no. 2, 63–110), but the question
of finiteness remains open.

**Definitions:**
- A "word" v is an element of the free group on n generators.
- The "verbal subgroup" vG is the subgroup of G generated by all values of v
  when we substitute elements of G for the generators.
- The "marginal subgroup" v*G consists of all elements g ∈ G such that
  substituting g for any one variable in v (while keeping other variables
  arbitrary) doesn't change the value compared to substituting 1 for that variable.
  Equivalently, g ∈ v*G iff for all substitutions σ and all i,
  v(σ[i ↦ g]) = v(σ[i ↦ 1]).
-/

import Mathlib.GroupTheory.FreeGroup.Basic
import Mathlib.GroupTheory.Index
import Mathlib.SetTheory.Cardinal.Finite

open Subgroup

/-- A group word is an element of the free group on n generators. -/
abbrev GroupWord (n : ℕ) := FreeGroup (Fin n)

/--
Evaluate a word by substituting group elements for each generator.
Uses the universal property of free groups.
-/
noncomputable def evalWord {n : ℕ} {G : Type*} [Group G]
    (w : GroupWord n) (σ : Fin n → G) : G :=
  FreeGroup.lift σ w

/--
Update a substitution by replacing the value at position i.
-/
def updateSubst {n : ℕ} {G : Type*} (σ : Fin n → G) (i : Fin n) (g : G) : Fin n → G :=
  Function.update σ i g

/--
The verbal subgroup vG is the subgroup of G generated by all values of v.
vG = ⟨v(σ) | σ : Fin n → G⟩
-/
def verbalSubgroup {n : ℕ} (G : Type*) [Group G] (v : GroupWord n) : Subgroup G :=
  Subgroup.closure {g : G | ∃ σ : Fin n → G, evalWord v σ = g}

/--
The marginal subgroup v*G consists of all elements g ∈ G such that
substituting g for any variable in v gives the same result as substituting 1.
Formally: g ∈ v*G iff for all σ : Fin n → G and all i : Fin n,
  v(σ[i ↦ g]) = v(σ[i ↦ 1])
-/
def marginalSubgroup {n : ℕ} (G : Type*) [Group G] (v : GroupWord n) : Subgroup G where
  carrier := {g : G | ∀ (σ : Fin n → G) (i : Fin n),
    evalWord v (updateSubst σ i g) = evalWord v (updateSubst σ i 1)}
  one_mem' := by
    intro σ i
    rfl
  mul_mem' := by
    intro a b ha hb σ i
    -- This requires showing that if a and b are marginal, so is a * b
    -- This is a nontrivial property that follows from the structure of free groups
    sorry
  inv_mem' := by
    intro a ha σ i
    -- If a is marginal, so is a⁻¹
    sorry

/--
Kourovka Problem 2.45 b) - Finiteness Part (OPEN):

If the marginal subgroup v*G has finite index m in G,
then the verbal subgroup vG is finite.

This is the part of Hall's conjecture that remains open according to the editors.
-/
theorem kourovka_2_45_finiteness
    {n : ℕ} (G : Type*) [Group G]
    (v : GroupWord n)
    (h_finite_index : (marginalSubgroup G v).FiniteIndex) :
    Finite (verbalSubgroup G v) := by
  sorry

/--
The divisibility part of Hall's conjecture has been DISPROVED by Kleiman (1983):
There exist groups G and words v such that v*G has finite index m in G,
vG is finite, but |vG| does not divide any power of m.

This statement asserts the existence of a counterexample.
-/
theorem kourovka_2_45_divisibility_counterexample :
    ∃ (n : ℕ) (G : Type*) (_ : Group G) (v : GroupWord n),
      (marginalSubgroup G v).FiniteIndex ∧
      Finite (verbalSubgroup G v) ∧
      ∀ (k : ℕ), ¬ (Nat.card (verbalSubgroup G v) ∣ (marginalSubgroup G v).index ^ k) := by
  sorry
