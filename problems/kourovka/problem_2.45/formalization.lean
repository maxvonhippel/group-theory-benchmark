/-
Kourovka Notebook Problem 2.45.b (P. Hall)

Conjecture: If the marginal subgroup v*G has finite index m in G, then the order
of vG is finite and divides a power of m.

Editors' comment: There are examples when |vG| does not divide a power of m
(Yu. G. Kleiman, Trans. Moscow Math. Soc., 1983, no. 2, 63–110), but the question
of finiteness remains open.

BACKGROUND:
- For a word v in the free group F_n on n generators, and a group G:
  - The verbal subgroup vG is the subgroup generated by all values v(g₁,...,gₙ)
    as g₁,...,gₙ range over G.
  - The marginal subgroup v*G consists of all elements g such that
    v(g₁,...,gᵢ·g,...,gₙ) = v(g₁,...,gₙ) for all gᵢ ∈ G and all positions i.

This formalization defines the necessary concepts and states the open finiteness question.
-/

import Mathlib

universe u

/-!
## Verbal and Marginal Subgroups

We formalize the concepts of verbal and marginal subgroups for a word in a free group.
-/

/--
Given a word w in the free group on type α, and an assignment of group elements
to the generators, we can evaluate the word in a group G.
This is the universal property of the free group.
-/
noncomputable def evalWord {α : Type*} {G : Type u} [Group G]
    (w : FreeGroup α) (assignment : α → G) : G :=
  FreeGroup.lift assignment w

/--
The set of all values of a word w when applied to all possible assignments in G.
-/
def wordValues {α : Type*} (G : Type u) [Group G] (w : FreeGroup α) : Set G :=
  { g | ∃ (assignment : α → G), evalWord w assignment = g }

/--
The verbal subgroup vG is the subgroup generated by all values of the word v in G.
-/
def verbalSubgroup {α : Type*} (G : Type u) [Group G] (v : FreeGroup α) : Subgroup G :=
  Subgroup.closure (wordValues G v)

/--
An element g is in the marginal subgroup v*G if multiplying g into any position
of any assignment does not change the word's value.

More precisely, g ∈ v*G iff for all assignments f : α → G and all a : α,
v(f) = v(f'), where f' agrees with f except f'(a) = f(a) * g.

This is a standard definition in the theory of varieties of groups.
-/
def marginalSubgroup {α : Type*} [DecidableEq α] (G : Type u) [Group G]
    (v : FreeGroup α) : Subgroup G where
  carrier := { g | ∀ (f : α → G) (a : α),
    evalWord v f = evalWord v (Function.update f a (f a * g)) }
  one_mem' := by
    intro f a
    simp only [mul_one, Function.update_eq_self]
  mul_mem' := fun {x y} hx hy f a => by
    -- The proof that the carrier is closed under multiplication
    sorry
  inv_mem' := fun {x} hx f a => by
    -- The proof that the carrier is closed under inverses
    sorry

/-!
## P. Hall's Conjecture

The original conjecture was:
If v*G has finite index m in G, then |vG| is finite and divides a power of m.

The divisibility part has been disproved (Kleiman 1983), but the finiteness
question remains open.
-/

/--
The finiteness part of Hall's conjecture: If the marginal subgroup has finite index,
then the verbal subgroup is finite.

This remains an open question as of the Kourovka Notebook commentary.
-/
theorem hall_conjecture_finiteness {α : Type*} [DecidableEq α] (G : Type u) [Group G]
    (v : FreeGroup α) (hFiniteIndex : (marginalSubgroup G v).FiniteIndex) :
    Finite (verbalSubgroup G v) := by
  sorry

/--
The full Hall conjecture (now known to be false in general):
If v*G has finite index m in G, then |vG| divides a power of m.

Kleiman (1983) provided counterexamples to this.
-/
theorem hall_conjecture_divisibility_false :
    ¬∀ (α : Type*) [DecidableEq α] (G : Type u) [Group G] (v : FreeGroup α),
      ∀ (hFiniteIndex : (marginalSubgroup G v).FiniteIndex),
        ∃ k : ℕ, Nat.card (verbalSubgroup G v) ∣ (marginalSubgroup G v).index ^ k := by
  sorry

/--
Alternatively, stated as a conjecture that would be true if Hall's divisibility
held (we state this form and mark it as unresolved/disproved):
-/
theorem hall_conjecture_divisibility {α : Type*} [DecidableEq α] (G : Type u) [Group G]
    (v : FreeGroup α) (hFiniteIndex : (marginalSubgroup G v).FiniteIndex)
    (hFiniteVerbal : Finite (verbalSubgroup G v)) :
    ∃ k : ℕ, Nat.card (verbalSubgroup G v) ∣ (marginalSubgroup G v).index ^ k := by
  -- This is FALSE in general (Kleiman 1983), but we include it for completeness
  sorry
