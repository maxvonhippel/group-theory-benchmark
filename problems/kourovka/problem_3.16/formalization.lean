/-
Kourovka Notebook Problem 3.16 (N. R. Brumberg)

Can a subgroup of a relatively free group be radicable?
In particular, can a verbal subgroup of a relatively free group be radicable?

A group is radicable (also called divisible) if for every element g and every
positive integer n, there exists an element h such that h^n = g.

A relatively free group is a group that is free in some variety of groups
(i.e., free among all groups satisfying a given set of group-theoretic laws).

A verbal subgroup is the subgroup generated by all values of words from a
given set of group words evaluated at all possible arguments in the group.
-/

import Mathlib.Algebra.Group.Defs
import Mathlib.Algebra.Group.Subgroup.Basic
import Mathlib.GroupTheory.FreeGroup.Basic

/-- A group G is radicable if every element has an nth root for every positive integer n.
    That is, for every g ∈ G and n ≥ 1, there exists h ∈ G such that h^n = g. -/
def IsRadicable (G : Type*) [Group G] : Prop :=
  ∀ g : G, ∀ n : ℕ, n ≥ 1 → ∃ h : G, h ^ n = g

/-- A subgroup H of G is radicable if every element of H has an nth root in H
    for every positive integer n. -/
def Subgroup.IsRadicable {G : Type*} [Group G] (H : Subgroup G) : Prop :=
  ∀ g : H, ∀ n : ℕ, n ≥ 1 → ∃ h : H, h ^ n = g

/-- A group word in variables indexed by ι is an element of the free group on ι -/
abbrev GroupWord (ι : Type*) := FreeGroup ι

/-- The value of a group word w at a given assignment of variables in a group G -/
def GroupWord.eval {ι : Type*} {G : Type*} [Group G] (w : GroupWord ι) (f : ι → G) : G :=
  FreeGroup.lift f w

/-- The verbal subgroup V(G) generated by a set of words W is the subgroup
    generated by all values of words in W evaluated at all possible arguments. -/
def verbalSubgroup {ι : Type*} (G : Type*) [Group G] (W : Set (GroupWord ι)) : Subgroup G :=
  Subgroup.closure { g : G | ∃ w ∈ W, ∃ f : ι → G, GroupWord.eval w f = g }

/-- A variety of groups is a class of groups closed under subgroups, quotients,
    and direct products, defined by a set of identities. We model this abstractly
    as a predicate on groups (at a fixed universe level). -/
structure GroupVariety where
  /-- The predicate characterizing groups in this variety -/
  mem : (G : Type) → [Group G] → Prop

/-- A group G is relatively free in variety V on generators X if:
    1. G belongs to V
    2. G is generated by X
    3. Any map from X to a group H in V extends to a homomorphism G → H -/
structure IsRelativelyFreeIn (V : GroupVariety) (G : Type) [Group G] where
  /-- The set of free generators -/
  generators : Set G
  /-- G belongs to the variety V -/
  mem_variety : V.mem G
  /-- G is generated by the generators -/
  generates : Subgroup.closure generators = ⊤
  /-- Universal property: any map from generators to a group in V extends to a homomorphism -/
  universal : ∀ (H : Type) [Group H], V.mem H →
    ∀ f : generators → H, ∃ φ : G →* H, ∀ x : generators, φ x.val = f x

/-- A group G is relatively free if it is free in some variety. -/
def IsRelativelyFree (G : Type) [Group G] : Prop :=
  ∃ (V : GroupVariety), Nonempty (IsRelativelyFreeIn V G)

/--
Kourovka Problem 3.16 (Part 1): Can a subgroup of a relatively free group be radicable?

This asks whether there exists a relatively free group G and a non-trivial
subgroup H of G such that H is radicable.
-/
def kourovka_3_16_part1 : Prop :=
  ∃ (G : Type) (_ : Group G), IsRelativelyFree G ∧
    ∃ (H : Subgroup G), H.IsRadicable ∧ Nontrivial H

/--
Kourovka Problem 3.16 (Part 2): Can a verbal subgroup of a relatively free group be radicable?

This is a more specific version asking whether a verbal subgroup can be radicable.
-/
def kourovka_3_16_part2 : Prop :=
  ∃ (ι : Type) (G : Type) (_ : Group G), IsRelativelyFree G ∧
    ∃ (W : Set (GroupWord ι)), (verbalSubgroup G W).IsRadicable ∧ Nontrivial (verbalSubgroup G W)

/-- The negative answer to Part 1 would state that no non-trivial radicable
    subgroups exist in relatively free groups. -/
theorem kourovka_3_16_part1_negative :
    ¬ kourovka_3_16_part1 := by
  sorry

/-- The positive answer to Part 1 would provide a witness. -/
theorem kourovka_3_16_part1_positive :
    kourovka_3_16_part1 := by
  sorry

/-- The negative answer to Part 2 would state that no non-trivial radicable
    verbal subgroups exist in relatively free groups. -/
theorem kourovka_3_16_part2_negative :
    ¬ kourovka_3_16_part2 := by
  sorry

/-- The positive answer to Part 2 would provide a witness. -/
theorem kourovka_3_16_part2_positive :
    kourovka_3_16_part2 := by
  sorry
