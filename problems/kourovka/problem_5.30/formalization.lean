/-
Kourovka Notebook Problem 5.30 (A. Yu. Ol'shanskiĭ)

Does the free group of rank 2 have an infinite ascending chain of verbal subgroups
each being generated as a verbal subgroup by a single element?

A verbal subgroup V_w(G) of a group G is the subgroup generated by all values of
a word w when evaluated at all possible tuples of elements from G.
-/

import Mathlib.GroupTheory.FreeGroup.Basic
import Mathlib.Algebra.Group.Subgroup.Basic
import Mathlib.Algebra.Group.Subgroup.Lattice
import Mathlib.Order.RelClasses

/-- The free group of rank 2 -/
abbrev F2 : Type := FreeGroup (Fin 2)

/--
Given a word w in a free group on n generators and a group G,
evaluating w at a tuple of elements (g₁, ..., gₙ) means applying the unique
homomorphism from the free group to G that sends generator i to gᵢ.
-/
def evalWord {n : ℕ} (w : FreeGroup (Fin n)) {G : Type*} [Group G]
    (assignment : Fin n → G) : G :=
  FreeGroup.lift assignment w

/--
The set of all values of a word w in a group G.
This is the set {w(g₁,...,gₙ) : gᵢ ∈ G}.
-/
def wordValues {n : ℕ} (w : FreeGroup (Fin n)) (G : Type*) [Group G] : Set G :=
  { g : G | ∃ assignment : Fin n → G, evalWord w assignment = g }

/--
A verbal subgroup of G generated by a single word w is the subgroup
generated by all values of w in G.
-/
def verbalSubgroup {n : ℕ} (w : FreeGroup (Fin n)) (G : Type*) [Group G] : Subgroup G :=
  Subgroup.closure (wordValues w G)

/--
A subgroup H of G is a verbal subgroup if it equals the verbal subgroup
generated by some word.
-/
def IsVerbalSubgroup {G : Type*} [Group G] (H : Subgroup G) : Prop :=
  ∃ (n : ℕ) (w : FreeGroup (Fin n)), H = verbalSubgroup w G

/--
A subgroup H of G is a verbal subgroup generated by a single element
(i.e., a word in a free group on some number of generators).
This is equivalent to IsVerbalSubgroup but emphasizes the "single word" aspect.
-/
def IsVerbalSubgroupBySingleWord {G : Type*} [Group G] (H : Subgroup G) : Prop :=
  ∃ (n : ℕ) (w : FreeGroup (Fin n)), H = verbalSubgroup w G

/--
An infinite strictly ascending chain of subgroups indexed by natural numbers.
-/
def IsInfiniteAscendingChain {G : Type*} [Group G] (chain : ℕ → Subgroup G) : Prop :=
  ∀ n : ℕ, chain n < chain (n + 1)

/--
Kourovka Problem 5.30:
Does the free group of rank 2 have an infinite ascending chain of verbal subgroups,
each being generated as a verbal subgroup by a single element?

The problem asks whether there exists such a chain V₀ ⊊ V₁ ⊊ V₂ ⊊ ...
where each Vₙ is a verbal subgroup generated by a single word.
-/
theorem kourovka_5_30 :
    ∃ (chain : ℕ → Subgroup F2),
      IsInfiniteAscendingChain chain ∧
      ∀ n : ℕ, IsVerbalSubgroupBySingleWord (chain n) := by
  sorry

/--
Equivalent formulation as a negation (if the answer is "no"):
There is no infinite strictly ascending chain of single-word verbal subgroups in F₂.
-/
theorem kourovka_5_30_negative :
    ¬∃ (chain : ℕ → Subgroup F2),
      IsInfiniteAscendingChain chain ∧
      ∀ n : ℕ, IsVerbalSubgroupBySingleWord (chain n) := by
  sorry

/--
The problem can also be understood in terms of the lattice of verbal subgroups.
This states that the set of verbal subgroups (by single words) does not satisfy ACC
(ascending chain condition).
-/
def verbalSubgroupsSatisfyACC : Prop :=
  ∀ (chain : ℕ → Subgroup F2),
    (∀ n, IsVerbalSubgroupBySingleWord (chain n)) →
    (∀ n, chain n ≤ chain (n + 1)) →
    ∃ N, ∀ n ≥ N, chain n = chain N

/-- The problem is equivalent to asking if verbal subgroups do NOT satisfy ACC -/
theorem kourovka_5_30_equiv_not_acc :
    (∃ (chain : ℕ → Subgroup F2),
      IsInfiniteAscendingChain chain ∧
      ∀ n : ℕ, IsVerbalSubgroupBySingleWord (chain n)) ↔
    ¬verbalSubgroupsSatisfyACC := by
  sorry
