/-
Kourovka Notebook Problem 5.44 (A. Yu. Ol'shanskiĭ)

A union A = ⋃_α V_α of varieties of groups (in the lattice of varieties) is called
irreducible if ⋃_{β≠α} V_β ≠ A for each index α.

Is every variety an irreducible union of (finitely or infinitely many) varieties
each of which cannot be decomposed into a union of two proper subvarieties?

Key concepts:
- A variety of groups is a class of groups closed under subgroups, quotients,
  and arbitrary products (equivalently, defined by a set of group identities).
- Varieties form a complete lattice under inclusion, with join being the variety
  generated by the union and meet being the intersection.
- A variety is join-irreducible if it cannot be expressed as V = V₁ ∨ V₂ where
  V₁, V₂ are proper subvarieties.
- The question asks if every variety can be written as an irreducible join
  of join-irreducible varieties.
-/

import Mathlib.GroupTheory.FreeGroup.Basic
import Mathlib.Algebra.Group.Subgroup.Basic
import Mathlib.GroupTheory.QuotientGroup.Basic

/-!
We model varieties of groups abstractly. A variety is characterized by which groups
belong to it, with appropriate closure properties.

Since a fully rigorous treatment of varieties requires handling universe polymorphism
and the subtleties of HSP closures, we work with an abstract lattice of varieties.
-/

/-- Abstract type representing varieties of groups.
    In the mathematical literature, a variety is a class of groups closed under
    subgroups (H), quotients (S for surjective homomorphisms), and products (P).
    Varieties form a complete lattice under inclusion. -/
axiom Variety : Type

/-- Partial order on varieties: V₁ ≤ V₂ means V₁ is a subvariety of V₂ -/
axiom Variety.le : Variety → Variety → Prop

instance : LE Variety := ⟨Variety.le⟩

axiom Variety.le_refl : ∀ V : Variety, V ≤ V
axiom Variety.le_trans : ∀ V₁ V₂ V₃ : Variety, V₁ ≤ V₂ → V₂ ≤ V₃ → V₁ ≤ V₃
axiom Variety.le_antisymm : ∀ V₁ V₂ : Variety, V₁ ≤ V₂ → V₂ ≤ V₁ → V₁ = V₂

instance : Preorder Variety where
  le_refl := Variety.le_refl
  le_trans := Variety.le_trans

instance : PartialOrder Variety where
  le_antisymm := Variety.le_antisymm

/-- The trivial variety containing only the trivial group -/
axiom Variety.trivial : Variety

/-- The variety of all groups -/
axiom Variety.all : Variety

/-- The trivial variety is the bottom element -/
axiom Variety.trivial_le : ∀ V : Variety, Variety.trivial ≤ V

/-- The variety of all groups is the top element -/
axiom Variety.le_all : ∀ V : Variety, V ≤ Variety.all

/-- The join (supremum) of two varieties -/
axiom Variety.join : Variety → Variety → Variety

axiom Variety.le_join_left : ∀ V₁ V₂ : Variety, V₁ ≤ Variety.join V₁ V₂
axiom Variety.le_join_right : ∀ V₁ V₂ : Variety, V₂ ≤ Variety.join V₁ V₂
axiom Variety.join_le : ∀ V₁ V₂ V₃ : Variety, V₁ ≤ V₃ → V₂ ≤ V₃ → Variety.join V₁ V₂ ≤ V₃

/-- The join of a family of varieties indexed by a type I -/
axiom Variety.iSup : {I : Type} → (I → Variety) → Variety

axiom Variety.le_iSup : ∀ {I : Type} (f : I → Variety) (i : I), f i ≤ Variety.iSup f
axiom Variety.iSup_le : ∀ {I : Type} (f : I → Variety) (V : Variety),
  (∀ i, f i ≤ V) → Variety.iSup f ≤ V

/-- A variety is join-irreducible if it cannot be expressed as the join of
    two strictly smaller varieties. Equivalently: V is join-irreducible if
    V = V₁ ∨ V₂ implies V = V₁ or V = V₂.

    In the problem context, this means the variety "cannot be decomposed into
    a union of two proper subvarieties". -/
def Variety.isJoinIrreducible (V : Variety) : Prop :=
  V ≠ Variety.trivial ∧
  ∀ V₁ V₂ : Variety, Variety.join V₁ V₂ = V → V₁ = V ∨ V₂ = V

/-- An indexed family of varieties gives an irreducible join if removing any
    single variety from the family gives a strictly smaller join.
    That is: for each α, ⋃_{β≠α} V_β ≠ ⋃_β V_β (strictly smaller). -/
def isIrreducibleJoin {I : Type} (f : I → Variety) : Prop :=
  ∀ α : I, Variety.iSup (fun β : {i : I // i ≠ α} => f β.val) < Variety.iSup f

/--
Kourovka Problem 5.44 (A. Yu. Ol'shanskiĭ):

Is every variety an irreducible union (join) of varieties that are
join-irreducible (cannot be decomposed into a join of two proper subvarieties)?

The question asks whether this decomposition always exists.
-/
theorem kourovka_5_44 :
    (∀ V : Variety, ∃ (I : Type) (f : I → Variety),
      (∀ i : I, (f i).isJoinIrreducible) ∧
      isIrreducibleJoin f ∧
      Variety.iSup f = V)
    ∨
    (∃ V : Variety, ¬∃ (I : Type) (f : I → Variety),
      (∀ i : I, (f i).isJoinIrreducible) ∧
      isIrreducibleJoin f ∧
      Variety.iSup f = V) := by
  sorry

/-- Alternative formulation: The affirmative answer to the problem -/
def kourovka_5_44_affirmative : Prop :=
  ∀ V : Variety, ∃ (I : Type) (f : I → Variety),
    (∀ i : I, (f i).isJoinIrreducible) ∧
    isIrreducibleJoin f ∧
    Variety.iSup f = V

/-- Alternative formulation: The negative answer to the problem -/
def kourovka_5_44_negative : Prop :=
  ∃ V : Variety, ¬∃ (I : Type) (f : I → Variety),
    (∀ i : I, (f i).isJoinIrreducible) ∧
    isIrreducibleJoin f ∧
    Variety.iSup f = V
