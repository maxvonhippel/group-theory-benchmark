/-
Kourovka Notebook Problem 6.59 (V. P. Shunkov)

A group G is said to be (conjugacy, p-conjugacy) biprimitively finite if, for any finite
subgroup H, any two elements of prime order (any two conjugate elements of prime order,
of prime order p) in N_G(H)/H generate a finite subgroup.

Prove that an arbitrary periodic (conjugacy) biprimitively finite group
(in particular, having no involutions) of finite rank is locally finite.

DEFINITIONS:
- A group is **periodic** (or **torsion**) if every element has finite order.
- A group is **locally finite** if every finitely generated subgroup is finite.
- A group is **biprimitively finite** if for any finite subgroup H, any two elements
  of prime order in N_G(H)/H generate a finite subgroup.
- A group is **conjugacy biprimitively finite** if for any finite subgroup H, any two
  *conjugate* elements of prime order in N_G(H)/H generate a finite subgroup.
- A group has **finite Prüfer rank** if there exists a bound r such that every finitely
  generated subgroup can be generated by at most r elements.
-/

import Mathlib.Algebra.Group.Subgroup.Lattice
import Mathlib.GroupTheory.Torsion
import Mathlib.GroupTheory.QuotientGroup.Basic
import Mathlib.Data.Nat.Prime.Defs
import Mathlib.Data.Finset.Basic
import Mathlib.GroupTheory.OrderOfElement

open Subgroup

variable {G : Type*} [Group G]

/-! ## Periodic Groups -/

/--
A group is **periodic** (or **torsion**) if every element has finite order.
-/
def IsPeriodic (G : Type*) [Group G] : Prop :=
  ∀ g : G, ∃ n : ℕ, n > 0 ∧ g ^ n = 1

/-! ## Locally Finite Groups -/

/--
A group is **locally finite** if every finitely generated subgroup is finite.
Equivalently, every finite subset generates a finite subgroup.
-/
def IsLocallyFinite (G : Type*) [Group G] : Prop :=
  ∀ (S : Finset G), Finite (closure (S : Set G))

/-! ## Prüfer Rank -/

/--
A group has **finite Prüfer rank** if there exists a bound r such that every
finitely generated subgroup can be generated by at most r elements.
-/
def HasFinitePruferRank (G : Type*) [Group G] : Prop :=
  ∃ r : ℕ, ∀ (S : Finset G), ∃ (T : Finset G), T.card ≤ r ∧ closure (T : Set G) = closure (S : Set G)

/-! ## Elements of Prime Order -/

/--
An element g has **prime order** if its order is a prime number.
-/
def HasPrimeOrder (g : G) : Prop :=
  ∃ p : ℕ, Nat.Prime p ∧ orderOf g = p

/--
The set of elements of prime order in G.
-/
def primeOrderElements (G : Type*) [Group G] : Set G :=
  { g : G | HasPrimeOrder g }

/-! ## Normalizer and Quotient -/

/--
For a subgroup H of G, this defines the set of elements in N_G(H)/H
that have prime order (as elements of the quotient).
-/
def primeOrderInQuotientNormalizer (H : Subgroup G) : Set (H.normalizer ⧸ H.subgroupOf H.normalizer) :=
  { q : H.normalizer ⧸ H.subgroupOf H.normalizer | HasPrimeOrder q }

/-! ## Biprimitively Finite Groups -/

/--
A group G is **biprimitively finite** if, for any finite subgroup H,
any two elements of prime order in N_G(H)/H generate a finite subgroup.

More precisely: For every finite subgroup H ≤ G, and any two elements
a, b ∈ N_G(H)/H of prime order, the subgroup ⟨a, b⟩ of N_G(H)/H is finite.
-/
def IsBiprimFinite (G : Type*) [Group G] : Prop :=
  ∀ (H : Subgroup G) [Finite H],
    ∀ (a b : H.normalizer ⧸ H.subgroupOf H.normalizer),
      HasPrimeOrder a → HasPrimeOrder b →
      Finite (closure ({a, b} : Set (H.normalizer ⧸ H.subgroupOf H.normalizer)))

/-! ## Conjugacy Biprimitively Finite Groups -/

/--
Two elements in a group are **conjugate** if one can be obtained from the other
by conjugation.
-/
def AreConjugate (a b : G) : Prop :=
  ∃ g : G, g * a * g⁻¹ = b

/--
A group G is **conjugacy biprimitively finite** if, for any finite subgroup H,
any two *conjugate* elements of prime order in N_G(H)/H generate a finite subgroup.
-/
def IsConjBiprimFinite (G : Type*) [Group G] : Prop :=
  ∀ (H : Subgroup G) [Finite H],
    ∀ (a b : H.normalizer ⧸ H.subgroupOf H.normalizer),
      HasPrimeOrder a → HasPrimeOrder b →
      (∃ (x y : H.normalizer), QuotientGroup.mk x = a ∧ QuotientGroup.mk y = b ∧
        ∃ g : H.normalizer, g * x * g⁻¹ = y) →
      Finite (closure ({a, b} : Set (H.normalizer ⧸ H.subgroupOf H.normalizer)))

/-! ## Involutions -/

/--
An element is an **involution** if it has order 2.
-/
def IsInvolution (g : G) : Prop :=
  g ≠ 1 ∧ g * g = 1

/--
A group has **no involutions** if no element has order 2.
-/
def HasNoInvolutions (G : Type*) [Group G] : Prop :=
  ∀ g : G, ¬IsInvolution g

/-! ## Main Theorem (Problem 6.59) -/

/--
**Kourovka Problem 6.59** (V. P. Shunkov):

An arbitrary periodic (conjugacy) biprimitively finite group of finite rank
is locally finite.

Note: The statement "(in particular, having no involutions)" indicates that
the hypothesis of having no involutions is a special case that implies
conjugacy biprimitive finiteness, strengthening the result.
-/
theorem kourovka_6_59
    (G : Type*) [Group G]
    (hPeriodic : IsPeriodic G)
    (hBiprimFinite : IsConjBiprimFinite G)
    (hFiniteRank : HasFinitePruferRank G) :
    IsLocallyFinite G := by
  sorry

/--
**Alternative formulation with plain biprimitive finiteness:**

If G is periodic, biprimitively finite (not just conjugacy), and of finite rank,
then G is locally finite.

This is a stronger hypothesis (biprimitively finite implies conjugacy biprimitively
finite), so the conclusion follows as a corollary.
-/
theorem kourovka_6_59_variant
    (G : Type*) [Group G]
    (hPeriodic : IsPeriodic G)
    (hBiprimFinite : IsBiprimFinite G)
    (hFiniteRank : HasFinitePruferRank G) :
    IsLocallyFinite G := by
  sorry

/--
**Special case:** Groups with no involutions.

The problem notes "in particular, having no involutions" as a sufficient condition.
Groups with no involutions are automatically conjugacy biprimitively finite in
a certain technical sense, so this provides a cleaner hypothesis.
-/
theorem kourovka_6_59_no_involutions
    (G : Type*) [Group G]
    (hPeriodic : IsPeriodic G)
    (hNoInv : HasNoInvolutions G)
    (hFiniteRank : HasFinitePruferRank G) :
    IsLocallyFinite G := by
  sorry

/-!
## Discussion

This problem concerns the structure theory of infinite groups with certain
finiteness conditions. The notion of "biprimitively finite" was introduced
by V. P. Shunkov and plays an important role in the study of locally finite
groups.

Key related results (mentioned in the problem):
- For periodic groups in general, local finiteness does NOT follow from
  biprimitive finiteness alone (counterexamples exist).
- The condition of finite Prüfer rank is crucial for the result.
- Groups with no involutions provide a special class where the arguments simplify.

The theorem essentially says that if we have enough control over the generation
of subgroups by elements of prime order (the biprimitive finiteness condition)
and we bound the complexity of finitely generated subgroups (finite rank),
then a periodic group must be locally finite.
-/
